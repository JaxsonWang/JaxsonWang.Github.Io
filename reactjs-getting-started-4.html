<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=6.4.1" rel="stylesheet" type="text/css">

<link href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/default.css" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.4.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32.ico?v=6.4.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16.ico?v=6.4.1">


  <link rel="mask-icon" href="/images/logo.svg?v=6.4.1" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '6.4.1',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="Props、State、Refs 与表单处理前言在前面的章节中我们已经对于 React 和 JSX 有初步的认识，我们也了解到 React Component 事实上可以视为显示 UI 的一个状态机（state machine），而这个状态机根据不同的 state（透过 setState() 修改）和 props（由父元素传入），Component 会出现对应的显示结果。本章将使用 React 官">
<meta name="keywords" content="Sock5">
<meta property="og:type" content="article">
<meta property="og:title" content="R04-Props&#x2F;State 基础与 Component 生命周期">
<meta property="og:url" content="https://jaxsonwang.github.io/reactjs-getting-started-4.html">
<meta property="og:site_name" content="淮城一只猫">
<meta property="og:description" content="Props、State、Refs 与表单处理前言在前面的章节中我们已经对于 React 和 JSX 有初步的认识，我们也了解到 React Component 事实上可以视为显示 UI 的一个状态机（state machine），而这个状态机根据不同的 state（透过 setState() 修改）和 props（由父元素传入），Component 会出现对应的显示结果。本章将使用 React 官">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://res.i95.me/wp-content/uploads/2016/09/react-lifecycle.png">
<meta property="og:updated_time" content="2018-09-28T15:38:37.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="R04-Props&#x2F;State 基础与 Component 生命周期">
<meta name="twitter:description" content="Props、State、Refs 与表单处理前言在前面的章节中我们已经对于 React 和 JSX 有初步的认识，我们也了解到 React Component 事实上可以视为显示 UI 的一个状态机（state machine），而这个状态机根据不同的 state（透过 setState() 修改）和 props（由父元素传入），Component 会出现对应的显示结果。本章将使用 React 官">
<meta name="twitter:image" content="https://res.i95.me/wp-content/uploads/2016/09/react-lifecycle.png">






  <link rel="canonical" href="https://jaxsonwang.github.io/reactjs-getting-started-4.html">



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>R04-Props/State 基础与 Component 生命周期 | 淮城一只猫</title>
  






  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?c2f0abf0cbe0d6b8d33de1598a8a43d9";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">淮城一只猫</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">关注互联网及IT科技的个人博客</p>
      
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-about">
    <a href="/about/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>
  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  
    

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://jaxsonwang.github.io/reactjs-getting-started-4.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="淮城一只猫">
      <meta itemprop="description" content="淮城一只猫，是一个关注于互联网、IT技术经验分享的个人独立博客。更新互联网最火热的IT技术文章、软件应用科技原创文章，提供全面深入的IT信息资讯服务，为访问者提供富有互联网资讯。致力成为互联网上最个性、最极客、具传播力的个人独立博客。">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="淮城一只猫">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">R04-Props/State 基础与 Component 生命周期
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2016-09-24 20:34:46" itemprop="dateCreated datePublished" datetime="2016-09-24T20:34:46+09:00">2016-09-24</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-09-29 00:38:37" itemprop="dateModified" datetime="2018-09-29T00:38:37+09:00">2018-09-29</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/编程技术/" itemprop="url" rel="index"><span itemprop="name">编程技术</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/reactjs-getting-started-4.html#comments" itemprop="discussionUrl">
                  <span class="post-meta-item-text">评论数：</span> <span class="post-comments-count valine-comment-count" data-xid="/reactjs-getting-started-4.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="Props、State、Refs-与表单处理"><a href="#Props、State、Refs-与表单处理" class="headerlink" title="Props、State、Refs 与表单处理"></a>Props、State、Refs 与表单处理</h1><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>在前面的章节中我们已经对于 React 和 JSX 有初步的认识，我们也了解到 React Component 事实上可以视为显示 UI 的一个状态机（state machine），而这个状态机根据不同的 state（透过 <code>setState()</code> 修改）和 props（由父元素传入），Component 会出现对应的显示结果。本章将使用 <a href="https://facebook.github.io/react/index.html" target="_blank" rel="noopener">React 官网首页上的范例</a>（使用 ES6+）来更进一步说明 Props 和 State 特性及在 React 如何进行事件和表单处理。</p>
<h3 id="Props"><a href="#Props" class="headerlink" title="Props"></a>Props</h3><p>首先我们使用 React 官网上的 A Simple Component 来说明 props 的使用方式。由于传入元件的 name 属性为 Mark，故以下程式码将会在浏览器显示 Hello, Mark。针对传入的 props 我们也有验证和预设值的设计，让我们撰写的元件可以更加稳定健壮（robust）。</p>
<p>HTML Markup：</p>
<pre><code>  &lt;meta charset=&quot;utf-8&quot;&gt;
  &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width&quot;&gt;
  &lt;title&gt;A Component Using External Plugins&lt;/title&gt;


&lt;!-- 这边方便使用 CDN 方式引入 react 、 react-dom 进行讲解，实务上和实战教学部分我们会使用 webpack --&gt;
&lt;script src=&quot;https://fb.me/react-15.1.0.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;https://fb.me/react-dom-15.1.0.js&quot;&gt;&lt;/script&gt;
  &lt;div id=&quot;app&quot;&gt;&lt;/div&gt;
    &lt;script src=&quot;./app.js&quot;&gt;&lt;/script&gt;
</code></pre><p>app.js，使用 ES6 Class Component 写法：</p>
<pre><code>class HelloMessage extends React.Component {
    constructor(props) {
        // 对于 OOP 物件导向程式设计熟悉的读者应该对于 constructor 建构子的使用不陌生，事实上它是 ES6 的语法糖，骨子裡还是 portotype based 物件导向程式语言。透过 extends 可以继承 React.Component 父类别。super 方法可以呼叫继承父类别的建构子
        super(props);
        this.state = {}
    }
    render() {
        return (
            &lt;div&gt;Hello {this.props.name}&lt;/div&gt;
        )
    }
}

// PropTypes 验证，若传入的 props type 不是 string 将会显示错误
HelloMessage.propTypes = {
  name: React.PropTypes.string,
}

// Prop 预设值，若对应 props 没传入值将会使用 default 值 Zuck
HelloMessage.defaultProps = {
 name: &apos;Zuck&apos;, 
}

ReactDOM.render(&lt;HelloMessage name=&quot;Mark&quot; /&gt;, document.getElementById(&apos;app&apos;));
</code></pre><p>使用 Functional Component 写法：</p>
<pre><code>// Functional Component 可以视为 f(d) =&gt; UI，根据传进去的 props 绘出对应的 UI。注意这边 props 是传入函式的参数。因此取用 props 不用加 this
const HelloMessage = (props) =&gt; (
    &lt;div&gt;Hello {props.name}&lt;/div&gt;
);

// PropTypes 验证，若传入的 props type 不是 string 将会显示错误
HelloMessage.propTypes = {
  name: React.PropTypes.string,
}

// Prop 预设值，若对应 props 没传入值将会使用 default 值 Zuck。用法等于 ES5 的 getDefaultProps
HelloMessage.defaultProps = {
 name: &apos;Zuck&apos;, 
}

ReactDOM.render(&lt;HelloMessage name=&quot;Mark&quot; /&gt;, document.getElementById(&apos;app&apos;));
</code></pre><p>在 jsbin 上的范例：</p>
<p><a href="http://jsbin.com/wadice/embed?html,js,console,output" target="_blank" rel="noopener">A Component Using External Plugins on jsbin.com</a></p>
<h3 id="State"><a href="#State" class="headerlink" title="State"></a>State</h3><p>接下来我们将使用 A Stateful Component 这个范例来讲解 State 的用法。在 React Component 可以自己管理自己的内部 state，并用 <code>this.state</code> 来存取 state。当 <code>setState()</code> 方法更新了 state 后将重新呼叫 <code>render()</code> 方法，重新绘製 component 内容。以下范例是一个每 1000 毫秒（等于1秒）就会加一的累加器。由于这个范例是 Stateful Component 因此仅使用 ES6 Class Component，而不使用 Functional Component。</p>
<p>HTML Markup：</p>
<pre><code>  &lt;meta charset=&quot;utf-8&quot;&gt;
  &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width&quot;&gt;
  &lt;title&gt;A Component Using External Plugins&lt;/title&gt;


&lt;script src=&quot;https://fb.me/react-15.1.0.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;https://fb.me/react-dom-15.1.0.js&quot;&gt;&lt;/script&gt;
  &lt;div id=&quot;app&quot;&gt;&lt;/div&gt;
    &lt;script src=&quot;./app.js&quot;&gt;&lt;/script&gt;
</code></pre><p>app.js：</p>
<pre><code>class Timer extends React.Component {
    constructor(props) {
        super(props);
        // 与 ES5 React.createClass({}) 不同的是 component 内自定义的方法需要自行绑定 this context，或是使用 arrow function 
        this.tick = this.tick.bind(this);
        // 初始 state，等于 ES5 中的 getInitialState
        this.state = {
            secondsElapsed: 0,
        }
    }
    // 累加器方法，每一秒被呼叫后就会使用 setState() 更新内部 state，让 Component 重新 render
    tick() {
        this.setState({secondsElapsed: this.state.secondsElapsed + 1});
    }
    // componentDidMount 为 component 生命周期中阶段 component 已插入节点的阶段，通常一些非同步操作都会放置在这个阶段。这便是每1秒钟会去呼叫 tick 方法
    componentDidMount() {
        this.interval = setInterval(this.tick, 1000);
    }
    // componentWillUnmount 为 component 生命周期中 component 即将移出插入的节点的阶段。这边移除了 setInterval 效力 
    componentWillUnmount() {
        clearInterval(this.interval);
    }
    // render 为 class Component 中唯一需要定义的方法，其回传 component 欲显示的内容
    render() {
        return (
          &lt;div&gt;Seconds Elapsed: {this.state.secondsElapsed}&lt;/div&gt;
        );        
    }
}

ReactDOM.render(&lt;Timer /&gt;, document.getElementById(&apos;app&apos;));
</code></pre><h3 id="事件处理（Event-Handle）"><a href="#事件处理（Event-Handle）" class="headerlink" title="事件处理（Event Handle）"></a>事件处理（Event Handle）</h3><p>在前面的内容我们已经学会如何使用 props 和 state，接下来我们要更进一步学习在 React 内如何进行事件处理。下列将使用 React 官网的 An Application 当做例子，实作出一个简单的 TodoApp。</p>
<p>HTML Markup：</p>
<pre><code>  &lt;meta charset=&quot;utf-8&quot;&gt;
  &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width&quot;&gt;
  &lt;title&gt;A Component Using External Plugins&lt;/title&gt;


&lt;script src=&quot;https://fb.me/react-15.1.0.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;https://fb.me/react-dom-15.1.0.js&quot;&gt;&lt;/script&gt;
  &lt;div id=&quot;app&quot;&gt;&lt;/div&gt;
    &lt;script src=&quot;./app.js&quot;&gt;&lt;/script&gt;
</code></pre><p>app.js：</p>
<pre><code>// TodoApp 元件中包含了显示 Todo 的 TodoList 元件，Todo 的内容透过 props 传入 TodoList 中。由于 TodoList 仅单纯 Render UI 不涉及内部 state 操作是 stateless component，所以使用 Functional Component 写法。需要特别注意的是这边我们用 map function 来迭代 Todos，需要留意的是每个迭代的元素必须要有 unique key 不然会发生错误（可以用自定义 id，或是使用 map function 的第二个参数 index）
const TodoList = (props) =&gt; (
    &lt;ul&gt;
        {
            props.items.map((item) =&gt; (
                &lt;li key={item.id}&gt;{item.text}&lt;/li&gt;
            ))
        }
    &lt;/ul&gt;
)

// 整个 App 的主要元件，这边比较重要的是事件处理的部份，内部有
class TodoApp extends React.Component {
    constructor(props) {
        super(props);
        this.onChange = this.onChange.bind(this);
        this.handleSubmit = this.handleSubmit.bind(this);
        this.state = {
            items: [],
            text: &apos;&apos;,
        }
    }
    onChange(e) {
    this.setState({text: e.target.value});        
    }
    handleSubmit(e) {
    e.preventDefault();
    const nextItems = this.state.items.concat([{text: this.state.text, id: Date.now()}]);
    const nextText = &apos;&apos;;
    this.setState({items: nextItems, text: nextText});
    }
    render() {
    return (
      &lt;div&gt;
        &lt;h3&gt;TODO&lt;/h3&gt;
        &lt;TodoList items={this.state.items} /&gt;
        &lt;form onSubmit={this.handleSubmit}&gt;
          &lt;input onChange={this.onChange} value={this.state.text} /&gt;
          &lt;button&gt;{&apos;Add #&apos; + (this.state.items.length + 1)}&lt;/button&gt;
        &lt;/form&gt;
      &lt;/div&gt;
    );
    }
}

ReactDOM.render(&lt;TodoApp /&gt;, document.getElementById(&apos;app&apos;));
</code></pre><p>以上介绍了 React 事件处理的部份，除了 <code>onChange</code> 和 <code>onSubmit</code> 外，React 也封装了常用的事件处理，如 <code>onClick</code> 等。若想更进一步了解有哪些可以使用的事件处理方法可以参考 <a href="https://facebook.github.io/react/docs/events.html" target="_blank" rel="noopener">官网的 Event System</a>。</p>
<h3 id="Refs-与表单处理"><a href="#Refs-与表单处理" class="headerlink" title="Refs 与表单处理"></a>Refs 与表单处理</h3><p>上面介绍了 props（传入后就不能修改）、state（随著使用者互动而改变）和事件处理机制后，我们将接续介绍如何在 React 中进行表单处理。同样我们使用 React 官网范例 A Component Using External Plugins 进行介绍。由于 React 可以容易整合外部的 libraries（例如：jQuery），本范例将使用 <code>remarkable</code> 结合 <code>ref</code> 属性取出 DOM Value 值（另外比较常用的作法是使用 <code>onChange</code> 事件处理方式处理表单内容），让使用者可以使用 Markdown 语法的所见即所得编辑器（editor）。</p>
<p>HTML Markup（记得除了引入 <code>react</code> 和 <code>react-dom</code> 外还要用 <code>CDN</code> 方式引入 <code>remarkable</code> 这个 <code>Markdown</code> 语法 parser 套件）：</p>
<pre><code>  &lt;meta charset=&quot;utf-8&quot;&gt;
  &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width&quot;&gt;
  &lt;title&gt;A Component Using External Plugins&lt;/title&gt;


&lt;script src=&quot;https://fb.me/react-15.1.0.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;https://fb.me/react-dom-15.1.0.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;https://cdn.jsdelivr.net/remarkable/1.6.2/remarkable.min.js&quot;&gt;&lt;/script&gt;
  &lt;div id=&quot;app&quot;&gt;&lt;/div&gt;
    &lt;script src=&quot;./app.js&quot;&gt;&lt;/script&gt;
</code></pre><p>app.js：</p>
<pre><code>class MarkdownEditor extends React.Component {
    constructor(props) {
        super(props);
        this.handleChange = this.handleChange.bind(this);
        this.rawMarkup = this.rawMarkup.bind(this);
        this.state = {
            value: &apos;Type some *markdown* here!&apos;,
        }
    }
    handleChange() {
    this.setState({value: this.refs.textarea.value});
    }
    // 将使用者输入的 Markdown 语法 parse 成 HTML 放入 DOM 中，React 通常使用 virtual DOM 作为和 DOM 沟通的中介，不建议直接由操作 DOM。故使用时的属性为 dangerouslySetInnerHTML
    rawMarkup() {
    const md = new Remarkable();
    return { __html: md.render(this.state.value) };        
    }
    render() {
    return (
      &lt;div className=&quot;MarkdownEditor&quot;&gt;
        &lt;h3&gt;Input&lt;/h3&gt;
        &lt;textarea
          onChange={this.handleChange}
          ref=&quot;textarea&quot;
          defaultValue={this.state.value} /&gt;
        &lt;h3&gt;Output&lt;/h3&gt;
        &lt;div
          className=&quot;content&quot;
          dangerouslySetInnerHTML={this.rawMarkup()}
        /&gt;
      &lt;/div&gt;
    );    
    }
}

ReactDOM.render(&lt;MarkdownEditor /&gt;, document.getElementById(&apos;app&apos;));
</code></pre><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>以上透过几个 React 官网首页上的范例介绍了 Props 和 State 特性及在 React 如何进行事件和表单处理这些 React 中核心的问题，若还不熟悉的读者建议重新亲自动手照著范例中的程式码敲过一遍，也可以使用像 <a href="http://jsbin.com/" target="_blank" rel="noopener">jsbin</a> 这样所见即所得的工具来练习，更能熟悉相关语法和 API 喔！接下来我们将探讨 Component 的生命周期。</p>
<h3 id="延伸阅读"><a href="#延伸阅读" class="headerlink" title="延伸阅读"></a>延伸阅读</h3><ol>
<li><a href="https://facebook.github.io/react/index.html" target="_blank" rel="noopener">React 官方网站</a></li>
<li><a href="https://facebook.github.io/react/docs/top-level-api.html" target="_blank" rel="noopener">Top-Level API</a></li>
</ol>
<h1 id="React-Component-规格与生命周期（Life-Cycle）"><a href="#React-Component-规格与生命周期（Life-Cycle）" class="headerlink" title="React Component 规格与生命周期（Life Cycle）"></a>React Component 规格与生命周期（Life Cycle）</h1><h3 id="前言-1"><a href="#前言-1" class="headerlink" title="前言"></a>前言</h3><p>经过前面的努力相信目前读者对于用 React 开发一些简单的元件（Component）已经有一定程度的掌握了，现在我们将更细部探讨 React Component 的规格和其生命周期。</p>
<h3 id="React-Component-规格"><a href="#React-Component-规格" class="headerlink" title="React Component 规格"></a>React Component 规格</h3><p>若读者还有印象的话，我们前面介绍 React 特性时有描述 React 的主要撰写方式有两种：一种是使用 ES6 Class，另外一种是 Stateless Components，使用 Functional Component 的写法，单纯渲染 UI。这边再帮大家複习一下上一个章节的简单范例：</p>
<ol>
<li><p>使用 ES6 的 Class（可以进行比较複杂的操作和元件生命周期的控制，相对于 stateless components 耗费资源） <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">    `// 注意元件开头第一个字母都要大写  </span><br><span class="line">    class MyComponent extends React.Component &#123;  </span><br><span class="line">    // render 是 Class based 元件唯一必须的方法（method）  </span><br><span class="line">    render() &#123;  </span><br><span class="line">    return (  </span><br><span class="line">    </span><br><span class="line">    Hello, &#123;this.props.name&#125;</span><br><span class="line">    </span><br><span class="line">      </span><br><span class="line">    );  </span><br><span class="line">    &#125;  </span><br><span class="line">    &#125;`</span><br><span class="line"></span><br><span class="line">``</span><br><span class="line"></span><br><span class="line">// PropTypes 验证，若传入的 props type 不符合将会显示错误  </span><br><span class="line">MyComponent.propTypes = &#123;  </span><br><span class="line">name: React.PropTypes.string,  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Prop 预设值，若对应 props 没传入值将会使用 default 值，为每个实例化 Component 共用的值  </span><br><span class="line">MyComponent.defaultProps = &#123;  </span><br><span class="line">name: &apos;&apos;,  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 将 元件插入 id 为 app 的 DOM 元素中  </span><br><span class="line">ReactDOM.render(, document.getElmentById(&apos;app&apos;));</span><br><span class="line"></span><br><span class="line">    2. 使用 Functional Component 写法（单纯地 render UI 的 stateless components，没有内部状态、没有实作物件和 ref，没有生命周期函数。若非需要控制生命周期的话建议多使用 stateless components 获得比较好的效能）</span><br></pre></td></tr></table></figure></p>
<p> // 使用 arrow function 来设计 Functional Component 让 UI 设计更单纯（f(D) =&gt; UI），减少副作用（side effect）<br> const MyComponent = (props) =&gt; (</p>
<pre><code>&lt;div&gt;Hello, {props.name}&lt;/div&gt;
</code></pre><p> );</p>
<p> // PropTypes 验证，若传入的 props type 不符合将会显示错误<br> MyComponent.propTypes = {</p>
<pre><code>name: React.PropTypes.string,
</code></pre><p> }</p>
<p> // Prop 预设值，若对应 props 没传入值将会使用 default 值<br> MyComponent.defaultProps = {</p>
<pre><code>name: &apos;&apos;, 
</code></pre><p> }</p>
<p> // 将 <mycomponent> 元件插入 id 为 app 的 DOM 元素中<br> ReactDOM.render(<mycomponent name="Mark">, document.getElmentById(‘app’));</mycomponent></mycomponent></p>
</li>
</ol>
<p>值得留意的是在 ES6 Class 中 <code>render()</code> 是唯一必要的方法（但要注意的是请保持 <code>redner()</code> 的纯粹，不要在裡面进行 <code>state</code> 修改或是使用非同步方法和浏览器互动，若需非同步互动请于 <code>componentDidMount()</code> 操作），而 Functional Component 目前允许 <code>return null</code> 值。 喔对了，在 ES6 中也不支援 <code>mixins</code> 複用其他元件的方法了。</p>
<h3 id="React-Component-生命周期"><a href="#React-Component-生命周期" class="headerlink" title="React Component 生命周期"></a>React Component 生命周期</h3><p>React Component，就像人会有生老病死一样有生命周期。一般而言 Component 有以下三种生命周期的状态：</p>
<ol>
<li>Mounting：已插入真实的 DOM</li>
<li>Updating：正在被重新渲染</li>
<li>Unmounting：已移出真实的 DOM</li>
</ol>
<p>针对 Component 的生命周期状态 React 也有提供对应的处理方法：</p>
<ol>
<li>Mounting - componentWillMount()</li>
</ol>
<ul>
<li>componentDidMount()</li>
</ul>
<ol start="2">
<li>Updating - componentWillReceiveProps(object nextProps)：已载入元件收到新的参数时呼叫</li>
</ol>
<ul>
<li>shouldComponentUpdate(object nextProps, object nextState)：元件判断是否重新渲染时呼叫，起始不会呼叫除非呼叫 forceUpdate()</li>
<li>componentWillUpdate(object nextProps, object nextState)</li>
<li>componentDidUpdate(object prevProps, object prevState)</li>
</ul>
<ol start="3">
<li>Unmounting - componentWillUnmount()</li>
</ol>
<p>很多读者一开始学习 Component 生命周期时会觉得很抽象，所以接下来用一个简单范例让大家感受一下 Component 的生命周期。读者可以发现当一开始载入元件时第一个会触发 <code>console.log(&#39;constructor&#39;);</code>，依序执行 <code>componentWillMount</code>、<code>componentDidMount</code> ，而当点击文字触发 <code>handleClick()</code> 更新 <code>state</code> 时则会依序执行 <code>componentWillUpdate</code>、<code>componentDidUpdate</code>：</p>
<p>HTML Markup：</p>
<pre><code>&lt;meta charset=&quot;utf-8&quot;&gt;
&lt;meta name=&quot;viewport&quot; content=&quot;width=device-width&quot;&gt;
&lt;script src=&quot;https://fb.me/react-15.1.0.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;https://fb.me/react-dom-15.1.0.js&quot;&gt;&lt;/script&gt;
&lt;title&gt;Component LifeCycle&lt;/title&gt;


&lt;div id=&quot;app&quot;&gt;&lt;/div&gt;
</code></pre><p>Component 生命周期展示：</p>
<pre><code>class MyComponent extends React.Component {
  constructor(props) {
    super(props);
    console.log(&apos;constructor&apos;);
    this.handleClick = this.handleClick.bind(this);
    this.state = {
      name: &apos;Mark&apos;,
    }
  }
  handleClick() {
    this.setState({&apos;name&apos;: &apos;Zuck&apos;});
  }
  componentWillMount() {
    console.log(&apos;componentWillMount&apos;);
  }
  componentDidMount() {
    console.log(&apos;componentDidMount&apos;);
  }
  componentWillReceiveProps() {
    console.log(&apos;componentWillReceiveProps&apos;);
  }
  componentWillUpdate() {
    console.log(&apos;componentWillUpdate&apos;);
  }
  componentDidUpdate() {
    console.log(&apos;componentDidUpdate&apos;);
  }
  componentWillUnmount() {
    console.log(&apos;componentWillUnmount&apos;);
  }
  render() {
    return (
      &lt;div onClick={this.handleClick}&gt;Hi, {this.state.name}&lt;/div&gt;
    );
  }
}

ReactDOM.render(&lt;MyComponent /&gt;, document.getElementById(&apos;app&apos;));
</code></pre><p><a href="http://jsbin.com/yokebo/embed?html,js,console,output" target="_blank" rel="noopener">点击看详细范例</a></p>
<p><img src="https://res.i95.me/wp-content/uploads/2016/09/react-lifecycle.png" alt="React Component 规格与生命周期"></p>
<p>其中特殊处理的函数 <code>shouldComponentUpdate</code>，目前预设 <code>return true</code>。若你想要优化效能可以自己编写判断方式，若採用 <code>immutable</code> 可以使用 <code>nextProps === this.props</code> 比对是否有变动：</p>
<pre><code>shouldComponentUpdate(nextProps, nextState) {
  return nextProps.id !== this.props.id;
}
</code></pre><h3 id="Ajax-非同步处理"><a href="#Ajax-非同步处理" class="headerlink" title="Ajax 非同步处理"></a>Ajax 非同步处理</h3><p>若有需要进行 Ajax 非同步处理，请在 <code>componentDidMount</code> 进行处理。以下透过 <code>jQuery</code> 执行 <code>Ajax</code> 取得 <code>Github API</code>　资料当做范例：</p>
<p>HTML Markup：</p>
<pre><code>&lt;meta charset=&quot;utf-8&quot;&gt;
&lt;meta name=&quot;viewport&quot; content=&quot;width=device-width&quot;&gt;
&lt;script src=&quot;https://fb.me/react-15.1.0.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;https://fb.me/react-dom-15.1.0.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;https://code.jquery.com/jquery-3.1.0.js&quot;&gt;&lt;/script&gt;
&lt;title&gt;GitHub User&lt;/title&gt;


&lt;div id=&quot;app&quot;&gt;&lt;/div&gt;
</code></pre><p>app.js</p>
<pre><code>class UserGithub extends React.Component {
    constructor(props) {
        super(props);
        this.state = {
          username: &apos;&apos;,
          githubtUrl: &apos;&apos;,
          avatarUrl: &apos;&apos;,
        }
    }
    componentDidMount() {
        $.get(this.props.source, (result) =&gt; {
            console.log(result);
            const data = result;
            if (data) {
              this.setState({
                    username: data.name,
                    githubtUrl: data.html_url,
                    avatarUrl: data.avatar_url
              });
            }
        });
    }
    render() {
        return (
          &lt;div&gt;
            &lt;h3&gt;{this.state.username}&lt;/h3&gt;
            &lt;img src={this.state.avatarUrl} /&gt;
            &lt;a href={this.state.githubtUrl}&gt;Github Link&lt;/a&gt;.
          &lt;/div&gt;
        );
    }
}

ReactDOM.render(
  &lt;UserGithub source=&quot;https://api.github.com/users/torvalds&quot; /&gt;,
  document.getElementById(&apos;app&apos;)
);
</code></pre><p><a href="http://jsbin.com/kupusa/embed?html,js,output" target="_blank" rel="noopener">点击看详细范例</a></p>
<h3 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h3><p>以上介绍了 React Component 规格与生命周期（Life Cycle）的概念，其中生命周期的概念对于初学者来说可能会比较抽象，建议读者跟著范例动手实作。接下来我们将更进一步介绍 <code>React Router</code> 让读者感受一下单页式应用程式（single page application）的设计方式。</p>
<h3 id="延伸阅读-1"><a href="#延伸阅读-1" class="headerlink" title="延伸阅读"></a>延伸阅读</h3><ol>
<li><a href="https://facebook.github.io/react/docs/component-specs.html#lifecycle-methods" target="_blank" rel="noopener">Component Specs and Lifecycle</a></li>
</ol>
<p><code></code></p>

      
    </div>

    

    
    
    

    

    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>淮城一只猫</li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://jaxsonwang.github.io/reactjs-getting-started-4.html" title="R04-Props/State 基础与 Component 生命周期">https://jaxsonwang.github.io/reactjs-getting-started-4.html</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明出处！</li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Sock5/" rel="tag"># Sock5</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/reactjs-getting-started-3.html" rel="next" title="R03-React/JSX/Component 简介">
                <i class="fa fa-chevron-left"></i> R03-React/JSX/Component 简介
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/reactjs-getting-started-5.html" rel="prev" title="R05-React Router 入门实战教学">
                R05-React Router 入门实战教学 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
    </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">淮城一只猫</p>
              <p class="site-description motion-element" itemprop="description">淮城一只猫，是一个关注于互联网、IT技术经验分享的个人独立博客。更新互联网最火热的IT技术文章、软件应用科技原创文章，提供全面深入的IT信息资讯服务，为访问者提供富有互联网资讯。致力成为互联网上最个性、最极客、具传播力的个人独立博客。</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">230</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">3</span>
                    <span class="site-state-item-name">分类</span>
                  
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">49</span>
                    <span class="site-state-item-name">标签</span>
                  
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  <a href="https://github.com/JaxsonWang" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i>GitHub</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="mailto:i@iiong.com" target="_blank" title="E-Mail"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  
                </span>
              
            </div>
          

          
          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Props、State、Refs-与表单处理"><span class="nav-number">1.</span> <span class="nav-text">Props、State、Refs 与表单处理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#前言"><span class="nav-number">1.0.1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Props"><span class="nav-number">1.0.2.</span> <span class="nav-text">Props</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#State"><span class="nav-number">1.0.3.</span> <span class="nav-text">State</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#事件处理（Event-Handle）"><span class="nav-number">1.0.4.</span> <span class="nav-text">事件处理（Event Handle）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Refs-与表单处理"><span class="nav-number">1.0.5.</span> <span class="nav-text">Refs 与表单处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#总结"><span class="nav-number">1.0.6.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#延伸阅读"><span class="nav-number">1.0.7.</span> <span class="nav-text">延伸阅读</span></a></li></ol></li></ol><li class="nav-item nav-level-1"><a class="nav-link" href="#React-Component-规格与生命周期（Life-Cycle）"><span class="nav-number">2.</span> <span class="nav-text">React Component 规格与生命周期（Life Cycle）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#前言-1"><span class="nav-number">2.0.1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#React-Component-规格"><span class="nav-number">2.0.2.</span> <span class="nav-text">React Component 规格</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#React-Component-生命周期"><span class="nav-number">2.0.3.</span> <span class="nav-text">React Component 生命周期</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Ajax-非同步处理"><span class="nav-number">2.0.4.</span> <span class="nav-text">Ajax 非同步处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#总结-1"><span class="nav-number">2.0.5.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#延伸阅读-1"><span class="nav-number">2.0.6.</span> <span class="nav-text">延伸阅读</span></a></li></ol></li></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">本博客所有文章是<a href="https://iiong.com">淮城一只猫</a>归档。</span>

  

  
</div>











        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.4.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.4.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.4.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.4.1"></script>
<script type="text/javascript" src="/js/src/highlight.pack.js?v=6.4.1"></script>
<script type="text/javascript">
hljs.initHighlightingOnLoad();
</script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.4.1"></script>



  



  








  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  
  
    
  
  <script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(function (item) {
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: true,
        notify: true,
        appId: 'CYNFVtmW68hwThPgXLqDFSh5-gzGzoHsz',
        appKey: 'SiCtdjUGhYsXKexd1eIkkdWE',
        placeholder: '支持Markdown评论',
        avatar:'mm',
        meta:guest,
        pageSize:'10' || 10,
        visitor: false
    });
  </script>



  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  
  

  

  

  

  

  

</body>
</html>
